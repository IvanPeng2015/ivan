Reduxæ ¸å¿ƒè®¾è®¡æ¨¡å¼ï¼šæ‰€æœ‰é€»è¾‘éƒ½é›†ä¸­åœ¨ä¸€ä¸ªå•ç‹¬çš„reducerå‡½æ•°ä¸­ï¼Œå¹¶ä¸”æ‰§è¡Œè¿™äº›é€»è¾‘çš„å”¯ä¸€æ–¹å¼å°±æ˜¯ä¼ ç»™ *Redux* ä¸€ä¸ªèƒ½å¤Ÿæè¿°å½“æ—¶æƒ…æ™¯çš„æ™®é€šå¯¹è±¡ï¼ˆplain objectï¼‰ã€‚Redux store è°ƒç”¨è¿™äº›é€»è¾‘å‡½æ•°ï¼Œå¹¶ä¼ å…¥å½“å‰çš„ state tree ä»¥åŠè¿™äº›æè¿°å¯¹è±¡ï¼Œè¿”å›æ–°çš„ state treeï¼Œæ¥ç€ Redux store ä¾¿å¼€å§‹é€šçŸ¥è¿™äº›è®¢é˜…è€…ï¼ˆsubscriberï¼‰state tree å·²ç»æ”¹å˜ã€‚

æ•°æ®storeä»£è¡¨æ•´ä½“ç»“æ„çš„çŠ¶æ€é›†ï¼Œä¾èµ–äºæ­¤çŠ¶æ€é›†çš„ **å‘å¸ƒè®¢é˜…** æ¨¡å¼ç”¨äºè§£è€¦actionså’Œexecutesï¼Œå°† **åŠ¨ä½œ** å’Œ **æ‰§è¡Œ** åˆ†å¼€å¤„ç†ã€‚æè¿°actionsç”¨çš„æ˜¯è¿”å›æ™®é€šå¯¹è±¡çš„å‡½æ•°ï¼Œä¸åŒactionsä¹‹é—´æœ¬å°±æ˜¯ç›¸äº’ç‹¬ç«‹è§£è€¦çš„ã€‚è€Œæè¿°æ‰€æœ‰executesç”¨çš„æ˜¯ä¸€æ•´ä¸ªå‡½æ•°ï¼Œå•ä¸ªactionè§¦å‘çš„å¯¹åº”executeåœ¨é‡Œé¢è¢«é™åˆ¶æ€§çš„å°è£…æˆä¸ºå‡½æ•°ï¼Œç§°ä¸ºreducerï¼Œç„¶åä¼ ç»™Array.prototype.reduce(reducer[, initialValue])ï¼Œé™å®šä¸ºç­¾åï¼ˆpreState, action) => newState çš„çº¯å‡½æ•°ç»“æ„ï¼Œæ¯ä¸ªreducerå‡½æ•°å¤„ç†çŠ¶æ€é›†storeçš„ä¸€éƒ¨åˆ†ï¼Œreducerå‡½æ•°çš„ç»„ç»‡ä¸¥æ ¼ä¾èµ–äºæ•°æ®å­˜å‚¨ã€‚

è¿™é‡Œéœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼ŒåˆæœŸç‰¹åˆ«å€¾å‘äºå°†ç»„ä»¶æ¨¡å—çš„ç»„ç»‡ä¸reducerå‡½æ•°ç»„ç»‡ç»“æ„å®Œå…¨è¿›è¡Œç±»ä¼¼çš„ç­‰åŒï¼Œå®è´¨ä¸Šï¼Œè¿™ä¸¤è€…ä¹‹é—´æ²¡æœ‰ä»»ä½•ç›´æ¥å…³è”ã€‚ç¬¬ä¸€ï¼Œç»„ä»¶æ¨¡å—çš„ç»“æ„ç»„ç»‡å¯ä»¥å¼‚å¸¸çµæ´»ï¼Œè‡ªç”±ç»„åˆåµŒå¥—ï¼Œç»„ä»¶æ˜¯æ•°æ®æ¶ˆè´¹è€…ï¼Œåªéœ€ä½¿ç”¨ä¸­é—´ä»¶è®¢é˜…æ‰€éœ€æ•°æ®ã€‚ç¬¬äºŒï¼Œreducerçš„ç»„ç»‡æ€»ç»“å‡ºä»¥ä¸‹æ¨¡å¼ï¼Œreduceræ˜¯æ•°æ®çš„ç”Ÿäº§è€…ï¼Œæ¯ä¸ªreducerå‡½æ•°èŒè´£æ˜¯æ›´æ–°æ•´ä½“æ•°æ®çš„ä¸€éƒ¨åˆ†ã€‚

* [Reducerå’ŒStateçš„åŸºæœ¬ç»“æ„](#Reducerå’ŒStateçš„åŸºæœ¬ç»“æ„)

* [æ‹†åˆ†Reduceré€»è¾‘](#æ‹†åˆ†Reduceré€»è¾‘)

### Reducerå’ŒStateçš„åŸºæœ¬ç»“æ„

æ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªå•ä¸€reducerã€‚ æ— è„‘ç»„ç»‡æ•´ä¸ªreducerçš„æ‰€æœ‰é€»è¾‘åœ¨å•ä¸€å‡½æ•°çš„è¯ï¼Œå¤§æ¦‚æ˜¯å¦‚ä¸‹å…¸å‹ç»“æ„çš„æ ·å­ï¼š
```js
// stateé»˜è®¤å€¼åˆå§‹åŒ–initialValue
function reducer(state = initialValue, action) {
  switch (action.type) {
    case 'INCREMENT':
      return newState(state, action); // ä¸€æ®µé€»è¾‘å¤„ç†å‡½æ•°
    case 'DECREMENT':
      return anotherState(state, action); //  å¦ä¸€æ®µé€»è¾‘å¤„ç†å‡½æ•°
    default:
      return state;
  }
}
```

æ•´ä¸ªåº”ç”¨åªæœ‰ä¹Ÿä¸€ä¸ªå•ä¸€storeã€‚storeæ•°æ®stateä¸­çš„é¡¶å±‚çŠ¶æ€æ ‘é€šå¸¸æ˜¯ä¸€ä¸ªPlain Objectå³æ™®é€šå¯¹è±¡ï¼Œå°±é¡¶å±‚è®¾è®¡æ¥è¯´ï¼Œç»„ç»‡é¡¶å±‚å¯¹è±¡æ•°æ®å¸¸ç”¨æ–¹å¼æ˜¯å°†æ•°æ®åˆ’åˆ†ä¸ºå­æ ‘ï¼Œæ¯ä¸ªé¡¶å±‚keyå¯¹åº”ç€å’Œ *ç‰¹å®šåŸŸ* æˆ–è€… *åˆ‡ç‰‡* ç›¸å…³è”çš„æ•°æ®ã€‚æ— è„‘ç»„ç»‡æ•´ä¸ªstoreçš„æ‰€æœ‰æ•°æ®åœ¨å•ä¸€å¯¹è±¡ä¸Šçš„è¯ï¼Œå°±æ˜¯æ¯ä¸€å±‚éƒ½ç”¨åˆ’åˆ†å­æ ‘çš„è¿™ç§æ–¹å¼ï¼Œå…¸å‹ç»“æ„å°±æ˜¯JSONæ ¼å¼ã€‚

å¤§å¤šæ•°åº”ç”¨ä¼šå¤„ç†å¤šç§æ•°æ®ç±»å‹ï¼Œé€šå¸¸å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼ˆæˆ‘ä»¬ä»¥reduxå…¸å‹example TODOsä¸ºä¾‹ï¼‰ï¼š

  * åŸŸæ•°æ®ï¼ˆDomain dataï¼‰: åº”ç”¨éœ€è¦å±•ç¤ºã€ä½¿ç”¨æˆ–è€…ä¿®æ”¹çš„æ•°æ®ï¼ˆæ¯”å¦‚ ä»æœåŠ¡å™¨æ£€ç´¢åˆ°çš„åˆ—è¡¨todosï¼‰
  * åº”ç”¨çŠ¶æ€ï¼ˆApp stateï¼‰: ç‰¹å®šäºåº”ç”¨æŸä¸ªè¡Œä¸ºçš„æ•°æ®ï¼ˆæ¯”å¦‚ â€œTodo 5 æ˜¯ç°åœ¨é€‰æ‹©çš„çŠ¶æ€â€ï¼Œæˆ–è€… â€œæ­£åœ¨è¿›è¡Œä¸€ä¸ªè·å– Todos çš„è¯·æ±‚â€ï¼‰
  * UI çŠ¶æ€ï¼ˆUI stateï¼‰: æ§åˆ¶ UI å¦‚ä½•å±•ç¤ºçš„æ•°æ®ï¼ˆæ¯”å¦‚ â€œç¼–å†™ TODO æ¨¡å‹çš„å¼¹çª—ç°åœ¨æ˜¯å±•å¼€çš„â€ï¼‰

Store ä»£è¡¨ç€åº”ç”¨æ ¸å¿ƒï¼Œå› æ­¤åº”è¯¥ç”¨åŸŸæ•°æ®ï¼ˆDomain dataï¼‰å’Œåº”ç”¨çŠ¶æ€æ•°æ®ï¼ˆApp stateï¼‰å®šä¹‰ Stateï¼Œè€Œä¸æ˜¯ç”¨ UI çŠ¶æ€ï¼ˆUI stateï¼‰ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œstate.leftPane.todoList.todos è¿™æ ·çš„ç»“æ„å°±æ˜¯ä¸€ä¸ªåä¸»æ„ï¼Œå› ä¸ºæ•´ä¸ªåº”ç”¨çš„æ ¸å¿ƒæ˜¯ â€œtodosâ€ è€Œä¸ä»…ä»…æ˜¯ UI çš„ä¸€ä¸ªæ¨¡å—ã€‚ todos è¿™ä¸ªåˆ‡ç‰‡æ‰åº”è¯¥æ˜¯ state ç»“æ„çš„é¡¶å±‚ã€‚

UI æ ‘å’ŒçŠ¶æ€æ ‘ä¹‹é—´å¾ˆå°‘æœ‰ 1 å¯¹ 1 çš„å…³ç³»ã€‚é™¤éä½ æƒ³æ˜ç¡®çš„è·Ÿè¸ªä½ çš„ Redux Store ä¸­å­˜å‚¨çš„ UI æ•°æ®çš„å„ä¸ªæ–¹é¢ï¼Œä½†å³ä½¿æ˜¯è¿™æ ·ï¼ŒUI æ•°æ®çš„ç»“æ„å’ŒåŸŸæ•°æ®çš„ç»“æ„ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚

ğŸ‘¤è®¤ä¸ºä¸€èˆ¬çš„ï¼Œä¸ç”¨å…¨å±€è¿½è¸ªçš„UIçŠ¶æ€å³ä¸å­˜åœ¨éœ€è¦ç»„ä»¶é—´é€šä¿¡çš„çŠ¶æ€æ•°æ®ï¼Œæœ€å¥½æ”¾äºlocal stateï¼ˆå®šä¹‰æ•°æ®ï¼‰ï¼Œç½®äºreduxå¤–éƒ¨ï¼Œåœ¨ç»„ä»¶å†…éƒ¨ç”¨setStateè¿›è¡Œæ›´æ–°ï¼ˆç®¡ç†çŠ¶æ€ï¼‰ï¼Œç”±ç»„ä»¶å†…éƒ¨è·å¾—æ›´å¥½çš„å°è£…ã€‚

ä¸€ä¸ªå…¸å‹çš„åº”ç”¨`state`å¤§è‡´ä¼šé•¿è¿™æ ·ï¼š

```js
{
    domainData1 : {},
    domainData2 : {},
    appState1 : {},
    appState2 : {},
    ui : {
        uiState1 : {},
        uiState2 : {},
    }
}
```

### æ‹†åˆ†Reduceré€»è¾‘

å¦‚ä¸Šæ‰€è¿°çš„å…¸å‹reducerå‡½æ•°ç»“æ„ï¼Œå‡½æ•°å¤æ‚åº¦äº`action.type`ç§ç±»æˆæ­£ç›¸å…³ï¼Œç”±åº”ç”¨å¤æ‚åº¦å†³å®šçš„ã€‚æ‹†åˆ†çš„è¿‡ç¨‹å« *[å‡½æ•°åˆ†è§£ï¼ˆfunctional decompositionï¼‰](http://stackoverflow.com/questions/947874/what-is-functional-decomposition)* ã€‚æ‹†åˆ†å‡ºçš„çŸ­å°çš„æ–°çš„å‡½æ•°é€šå¸¸åˆ†ä¸ºä¸‰ç±»ï¼š

  * **util function** ä¸€äº›å°çš„å·¥å…·å‡½æ•°ï¼ŒåŒ…å«ä¸€äº›å¯é‡ç”¨çš„é€»è¾‘ç‰‡æ®µã€‚
  * **root reducer**: é€šå¸¸ä½œä¸º`createStore`ç¬¬ä¸€ä¸ªå‚æ•°çš„å‡½æ•°ã€‚

  * **slice reducer**: è´Ÿè´£å¤„ç†çŠ¶æ€æ ‘ä¸­ä¸€å—åˆ‡ç‰‡æ•°æ®çš„å‡½æ•°ï¼Œå‡½æ•°ç­¾åé€šå¸¸ä¸º`(state, action) -> newState`ï¼Œé€šå¸¸ä¼šä½œä¸º`higher-order reducer`å‡½æ•°çš„å‚æ•°ï¼Œå•ä¸ªslice reducerå‡½æ•°æ˜¯ç»è¿‡higher-order reducerå¤„ç†å¥½æ•°æ®åˆ‡åˆ†çš„å°ä»»åŠ¡å‡½æ•°ã€‚

  * **case function**: ä¸€ä¸ªè´Ÿè´£å¤„ç†ç‰¹å®š`action`çš„æ›´æ–°é€»è¾‘çš„å‡½æ•°ã€‚å¯èƒ½å°±æ˜¯ä¸€ä¸ª`reducer`å‡½æ•°ï¼Œä¹Ÿå¯èƒ½éœ€è¦å…¶ä»–å‚æ•°æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚è¿™ä¸ªå‡½æ•°å…¶å®å¾ˆç›´è§‚ï¼Œç†ç”±å°±æ˜¯ä¸€ä¸ªåˆ‡ç‰‡å‡½æ•°å¤„ç†çš„action caseä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œå°†å…¶ä¸­å¤æ‚çš„caseå¤„ç†ç®€å•æŠ½å‡ºæ¥æˆä¸ºå•ä¸ªå‡½æ•°ï¼›æˆ–è€…å•ä¸ªcaseè¿‡äºå¤æ‚ï¼ŒæŒ‰ç…§å…¶ä»–å‚æ•°å†åº¦è¿›è¡Œåˆ’åˆ†ã€‚
  ```js
  // caseå‡½æ•°æŸ¥æ‰¾å‡½æ•°ï¼Œå‡å°‘switch caseæ ·æ¿ä»£ç 
  function createReducer(initialState, handlers) {
    return function reducer(state = initialState, action) {
      if (handlers.hasOwnProperty(action.type)) {
        return handlers[action.type](state, action);
      } else {
        return state;
      }
    }
  }
  // Slice reduceré€šå¸¸å¦‚ä¸‹é¢è¿™æ ·æ‹†åˆ†ä¸ºactionå¯¹åº”çš„caseå‡½æ•°ï¼Œä»¥åˆ‡ç‰‡stateåˆå§‹å€¼å’ŒæŸ¥æ‰¾è¡¨ä¸ºå‚æ•°
  const todosReducer = createReducer([], {
    'ADD_TODO' : addTodo,
    'TOGGLE_TODO' : toggleTodo,
    'EDIT_TODO' : editTodo
  });
  ```

  * **higher-order reducer**: ä¸€ä¸ªä»¥`reducer`å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä¸”/æˆ–è¿”å›ä¸€ä¸ªæ–°çš„`reducer`å‡½æ•°çš„å‡½æ•°ï¼ˆæ¯”å¦‚ï¼š`combineReducers`, `redux-undo`ï¼‰ã€‚è´Ÿè´£åˆ†è§£stateçš„ç»“æ„ç»™å„ä¸ªåˆ‡ç‰‡ï¼Œä½†å¹¶éæ¯ä¸€å±‚çš„çŠ¶æ€æ ‘ç»“æ„éƒ½æ˜¯æ™®é€šå¯¹è±¡ï¼Œå½“ç„¶é€šå¸¸æˆ‘ä»¬æ„å»ºçš„storeé¡¶å±‚æ˜¯æ™®é€šå¯¹è±¡ï¼Œ`combineReducers`è¿™ä¸ªå‡½æ•°åœ¨é¡¶å±‚å°±é€šå¸¸å¾—åˆ°ä½¿ç”¨ï¼Œä½†è‹¥æ¯å±‚å®Œå…¨æŒ‰ç…§é¡¶å±‚è®¾è®¡ä½¿ç”¨æ™®é€šå¯¹è±¡ï¼Œå…¸å‹åº”ç”¨reducerçš„ç»„ç»‡ç»“æ„å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š
  ```js
  const rootReducer = combineReducers({
    login,
    // anti-patterns åŸŸæ•°æ®éƒ½æ˜¯æ•°æ®ç»“æ„çš„é¡¶å±‚
    account: combineReducers({
      schoolInfo,
      careerInfo: combineReducers({
        companyList,
        jobList,
      }),
      familyInfo,
    }),
    // è¿™ä¸€å±‚æœ‰ç›¸åº”çš„åˆ‡ç‰‡å¤„ç†
    register: (state = {}, action) => {
      switch(action.type){
        case 1: {
          return state;
        }
        // è¿™ä¸€å±‚çš„åˆ‡ç‰‡caseæœ¬èº«å¤„ç†å®Œæ¯•ï¼Œä»ç„¶è¦å¯¹è¿™ä¸€å±‚stateè¿›è¡Œæ™®é€šå¯¹è±¡çš„åˆ‡ç‰‡åˆ†è§£
        default: combineReducers({
          accountInfo,
          timeInfo,
        })(state, action)
      }
    },
    // è·¯ç”±
    routing:routerReducer,
  });
  ```
  å…¶å®æŒ‰ç…§storeæ•°æ®ç»“æ„ç»™å‡ºçš„ç»“è®ºï¼Œä¸Šä¾‹çš„æ•°æ®ç»“æ„åº”è¯¥æ˜¯æ‰å¹³çš„ï¼Œå³state.account.careerInfo.companyListè¿™æ ·çš„è®¾è®¡æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚æˆ‘ä»¬çš„ç›®çš„è®¾è®¡ä¸åŒçš„higher-order reducerå‡½æ•°æ¥é’ˆå¯¹ä¸ä¸€æ ·çš„æ•°æ®ç»“æ„è¿›è¡Œåˆ‡ç‰‡ã€‚

reduxåº“å·¥å…·å‡½æ•°`combineReducers`åŠ ä¸Š **slice reducer** é…åˆçŠ¶æ€æ ‘key-valueç»“æ„æ˜¯è¾ƒä¸ºå¸¸ç”¨æ™®éçš„ï¼Œæ›´æ–°é€»è¾‘è¢«å§”æ‰˜åœ¨åŸºäºæ™®é€šå¯¹è±¡ç»“æ„çš„stateåˆ‡ç‰‡çš„å„ä¸ª**slice reducer** å‡½æ•°ä¸­ã€‚

ä¸è¦å°†æ¯ä¸€å±‚çš„æ•°æ®ç»“æ„éƒ½è‡†æƒ³æˆæ™®é€šå¯¹è±¡ï¼Œå…¨å±€åªå‡ºç°äº† **slice reducer** å‡½æ•°ä»¥åŠå®˜æ–¹æä¾›çš„å·¥å…·å‡½æ•°combineReducerã€‚äº‹å®ä¸Šï¼Œåº”å……åˆ†åˆ©ç”¨ **higher-order reducer** **slice reducer** **case function** ä¸‰ç§æ–¹å¼æ‹†åˆ†é€»è¾‘ï¼Œæ‰å¯ä»¥å°†æ··æ‚åœ¨å„ç§æ•°æ®ç»“æ„ä¸­çš„rootReducerå‡½æ•°åˆ†è§£ä¸ºè€¦åˆåº¦ä½çš„å„ç±»å‡½æ•°ã€‚

### Highter-order reducerè¿›é˜¶

* reduxåº“combineReducerså‡½æ•°

  åº”ç”¨åœºæ™¯ï¼šæŠŠä¸åŒç‰‡æ®µçš„`state`çš„æ›´æ–°å·¥ä½œå§”æ‰˜ç»™ä¸€ä¸ªç‰¹å®šçš„`reducer`ï¼Œä»¥æ­¤æ›´æ–°ç”±æ™®é€šçš„`JavaScript`å¯¹è±¡æ„æˆçš„`state`æ ‘ã€‚

* [redux-immutalbe](https://github.com/gajus/redux-immutable)åº“combineReducerså‡½æ•°

  åº”ç”¨åœºæ™¯ï¼šå¤„ç†Immutable.js Mapå¯¹è±¡ç»“æ„çš„stateæ ‘ã€‚

* ä¸åŒslice reducersä¹‹é—´å…±äº«æ•°æ®

  æŠŠæ‰€éœ€æ•°æ®å½“é¢å¤–å‚æ•°çš„å½¢å¼ä¼ é€’ç»™è‡ªå®šä¹‰å‡½æ•°ï¼Œè¿™é‡Œé¢æ–¹æ³•å¤ªå¤šï¼Œè¾ƒä¸ºç›´æ¥ã€ç®€æ´çš„é€šå¸¸åšæ³•æ˜¯ **é€šè¿‡thunkå‡½æ•°getStateæ–¹æ³•åœ¨è§¦å‘actionçš„å‰ä¸€æ­¥ç«‹å³è·å–å…¶å…¶å®ƒåˆ‡ç‰‡reducerä¸Šçš„æ•°æ®**ã€‚

  âŒä¸è¦é€šè¿‡connectè·å–å†ä¼ å‚ç»™actionã€å¯¼è‡´æ¯æ¬¡æ­¤æ•°æ®æ›´æ–°å³æ‰¾å¯»ç›¸å…³connectäº†çš„ç»„ä»¶è¿›è¡Œæ›´æ–°æ£€æµ‹æ¸²æŸ“ã€‘ï¼Œé™¤ééœ€è¦ç‰¹å®šæ¸²æŸ“çš„æ•°æ®ã€‚

  âŒæ›´ä¸è¦è¿˜å¾€å‰ä¸€æ­¥åœ¨containeræ–¹æ³•ä¸Šç”¨propsè·å–ç„¶åä¼ ä¸‹æ¥ã€‚ä¸ä½¿ç”¨combineReducersï¼Œè€Œä½¿ç”¨åŸå§‹reducerå†™æ³•è§£å†³å…±äº«æ•°æ®ç‰‡æ®µæ›´æ–°ç›´æ¥æ‰“ä¹±äº†æ•´ä¸ªreducerçš„æ‹†åˆ†ã€‚ä½¿ç”¨combineReducersæ–¹æ³•åŒ…è£¹å‡½æ•°è§£å†³äº¤å‰åœºæ™¯é—®é¢˜çš„æ–¹å¼ï¼ŒåŒæ ·æ˜¯æ‰“ä¹±äº†åˆ‡ç‰‡æ‹†åˆ†reducerçš„ç»Ÿä¸€æ–¹å¼ã€‚
